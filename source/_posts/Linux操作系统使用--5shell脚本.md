---
title: Linux操作系统使用--5shell脚本
date: 2017-10-23 09:21:15
categories: 嵌入式
tags: [嵌入式,学习笔记,shell脚本]
comments: true

---
>本篇文章围绕shell脚本编程，介绍了shell变量、常用的功能性语句和结构性语句，并通过实例分析进一步理解shell脚本的使用。<!-- more -->

# shell简介
- 计算机不能直接理解高级语言，而需要将高级语言翻译成可以理解的机器语言。翻译的方式有两种：编译和解释。而shell脚本就是一种解释性语言。
- shell脚本对于管理系统任务和其他重复性工作，有很好的表现。例如在/etc/rcx.d/文件夹下有许多脚本文件，用来存储系统配置和建立服务，必要时可以修改。再例如网络配置重启时，使用命令/etc/init.d/networking restart，其中networking就是一个脚本文件。
- shell脚本和windows系统下的批处理类似，脚本文件类似于.bat文件。

**shell脚本的本质**
shell命令的有序集合。

**shell脚本的目的**
批量执行shell命令。

**shell编程的基本过程**

1. 建立shell文件
2. 赋予shell文件执行权限
3. 执行shell文件

*注：执行时要加上./才可以。因为标准搜索路径没有当前路径。*

# shell变量
## 基本概念
- shell允许变量，但是不支持变量类型，所有赋值给变量的值都解释为一串字符。不需要声明。
- 变量赋值不能有空格，否则解析为命令。
- 通常使用全大写表示shell变量。
- 变量的调用：在变量前加$，可以使用{}区分其他内容，即${}。
- 使用unset命令删除变量的赋值，如unset VAR。
- 用#开头表示注释，通常在脚本的第一行写#! /bin/bash表示用哪种类型shell解释该程序。

## 变量类型
1. 用户自定义变量
2. 位置变量（命令行参数）
$0表示脚本文件名。$1、$2……${10}等分别表示命令行第一个参数，第二个参数……第十个参数。
3. 预定义变量
	- $# 表示命令行参数个数。
	- $@或$* 表示所有命令行参数，不包括命令名称。
	- $? 表示前一个命令的退出状态。
	- $$ 表示正在执行的进程ID号。	
*注意预定义变量和makefile的自动变量区分。*
4. 环境变量
在[《Linux操作系统使用--4常用shell命令汇总》][13]中有相关描述，此处不再赘述。
补充：使用set命令查看所有本地定义的shell变量，包括环境变量。

## 使用说明
1. shell允许变量，但是不支持变量类型，所有赋值给变量的值都解释为一串字符。不需要声明。
2. 变量赋值：VAR=var,不能有空格，否则解析为命令。通常变量使用全大写表示。
3. 变量调用：在变量前加$即可，可以使用{}区分别的内容，即${}，避免歧义。
4. 使用unset命令删除变量的赋值，如unset VAR。也可清除环境变量。
5. 用#开头表示注释，通常在脚本的第一行写“#! /bin/bash”表示用哪种类型shell解释该程序。

# 常用功能性语句
## read
read var1 var2 var3……表示从标准输入读入一行，把读入的第一个单词赋给var1，把第二个单词赋给var2，其余所有的词赋给var3。
*注：read是阻塞等待输入的。*

## expr
expr用于简单的整数运算，包括加(+)、减(-)、乘(\\\*)、整除(/)、求模(%)等。
*注：*
*1. expr和运算符之间有空格，运算符之间有空格。*
*2. expr结果赋值给变量，需要使用命令置换。*
*3. 变量运算时，必须使用expr。不能使用$I=$I+1，而是let i++或者expr 1 + 1。切记shell脚本的目的不是做运算。*

## test
test用来测试字符串、整数、文件属性，每一种有不同的测试操作符。

**字符串**
s1=s2,判断s1字符串和s2字符串是否相等。还有s1!=s2、\-z s1、\-n s1等,详情参阅手册man test。

**整数**
a \-eq b,判断a和b是否相等。在a和b之间还有\-ne、\-gt、\-ge、\-lt、\-le等，详情参阅手册。

**文件属性**
\-d name,判断name是否为一个目录。name前还可以有\-e、 \-f、 \-L、\-r、\-w、\-x、\-s等。以及f1 \-nt f2、f1 \-ot f2等。详情参阅手册。
*注：*
*1. 可以使用[]代替test，在使用条件语句时常用。注意[]内的内容离左右两个括号都有一个空格。*
*2. 字符串比较，等号和不等号两边的字符串有空格，且字符串要加双引号。*
*3. 使用echo $?查看test结果，真为0,假为1。*
*4. 在系统调用中可以使用stat取得文件属性。*

## echo
echo用于向标准输出打印字符串。
*注:*
*1. 单引号不解析特殊字符，原样输出。双引号解析特殊字符，进行替换输出。因此如需打印变量的值，需使用双引号。*
*2. echo在打印空格时，若加上双引号，每个空格都打印。若不加，两个单词间多个空格只当做分割两个单词的符号，打印一个空格。* 
*参考文档：[shell脚本中单引号(‘)和双引号(“)的使用区别][1]*

## set
set用于跟踪调试shell脚本。
set \-e表示脚本执行出现了返回值为非零时，整个脚本立即退出。
set \-x表示set命令之后执行的每一条命令以及加载命令行中的任何参数都会显示出来。

## 各种括号
在shell脚本中，常常会使用各种括号。例如：

- []单中括号可以替代test。
- [[]]双中括号用于字符串模式匹配，例如if [["$i" =~ ".sh"]] 判断是否包含.sh后缀。
- {}花括号和$一起使用，${}表示区分其他字符。{}内还可以加入逗号或者“..”表示扩展，例如{1..5}。
- ()圆括号和$一起使用，$()和反引号``作用一样，表示取值。
- (())双圆括号用在算术运算中，例如for ((I=0;I<10;I++))循环。

*参考文档：[shell中各种括号的作用\(\)、\(\(\)\)、\[\]、\[\[\]\]、\{\}][2]*

# 结构性语句
shell脚本中的结构性语句主要是掌握每种语句的书写格式,使用方法类似c语言，但不能照搬，注意shell脚本的主要任务是执行命令集合。

## 条件语句
```c
if 条件
then 
	命令1
	命令2
fi

if 条件1
then
	命令1
elif 条件2
then
	命令2
else
	命令N
fi
```

说明：

1. if i<5用shell表示为if (($i<5)), 或者if [ $i -lt 5 ]。
2. 在脚本中常看到if和then写在一行，用分号隔开。例如if [$i -lt 5];then

## 多路分支
```c
case 字符串变量 in
模式1）
	命令1
	;;
模式2)
	命令2
	;;
esac
```

说明：

1. case只能识别字符串变量，且字符串要加双引号。
2. 模式可以使用通配符，也可以同时匹配两个模式，使用|单竖线即可，通常最后一个模式使用*通配剩下所有情况。
3. 匹配模式为字符串匹配。
4. 使用;;结束，类似于c语言中的break。

## 循环语句
### for循环
```
for 变量名 in 单词表
do
	命令表
done
```

说明：

1. 这里不是用变量名匹配单词表，而是使用单词表里单词的个数作为循环的次数。
2. for循环适用于循环次数确定。
3. 如果单词表为所有命令行参数，可以省略“in 单词表”。
4. 一定要区分和c语言中的for循环，shell脚本主要是执行命令。
5. 示例：for ((I=0;I<10;I++))，for i in \`seq 1 2 10\`（表示从1开始到10,间隔为2），for i in {1..5} (表示从1到5,间隔为1)。

## while循环
```c
while 命令或表达式
do
	命令表
done
```

说明:

1. while用于循环次数不确定。
2. 死循环为while true。
3. while语句的退出状态为命令表中最后一条命令的退出状态。

## 循环控制语句
```c
break n 

continue
```

说明：break n表示跳出n层循环，而continue表示转到最近一层循环语句的下一轮循环上。

# shell函数

1. 定义：把完成固定功能且多次使用的一组命令封装在一个函数里，使用时调用函数名即可。
2. 原则：遵循先定义后调用。
3. 函数只在当前shell起作用，不能输出到子shell中。
4. 定义格式：函数名()或者function 函数名()，没有形参，使用命令行传参。
5. 调用格式：置换的方式赋值给变量或者单独调用。调用时，就相当于使用一个命令。
6. 函数返回：由return返回或者使用echo $?查看结果。
7. 可以在函数中定义局部变量，使用local修饰。

# 实例分析

通过分析三个实践中使用过的shell脚本。进一步理解shell脚本编程。源代码详见[gist][3]。

## automatic mount disk in openwrt
1. 该例子是openwrt系统下自动挂载的脚本。编辑文件为/etc/hotplug.d/block/30-disk-mount。	
2. 该段代码主要是case……esac语句的使用。模式有add和remove。

*参考文档：*
*1. [openwrt hotplug][4]*
*2. [OpenWrt中的热拔插Hotplug.d中的脚本][5]*

## mkconfig in uboot source code
1. 该例子是uboot源代码顶层目录下的配置文件，在Makefile中调用，作用是完成编译前针对特定单板的配置工作，编辑文件为u-boot-2013.01/mkconfig。
2. -a表示&&，-o表示||，在单中括号中使用-a和-o，在双中括号中使用&&和||。
3. set ${line}表示把line变量设置为当前shell的变量。
4. shift用来向左移动位置参数。
5. if ["字符串"]表示判断字符串是否为空。
6. awk是一个文本分析工具，可以用于字符串匹配分割等。
7. sed是一个流编辑器，可以用于字符串的替换过滤等。
8. 关于uboot源码的配置编译在系统移植部分再具体分析。

*参考文档：*
*1.[(三)u-boot2013.01.01 for s5pv210：《mkconfig分析》][9] *
*2. [linux awk命令详解][10]*
*3. [Shell脚本学习之sed详解][11]*

## networking service in ubuntu
1. 该例子是Ubuntu系统下重启网络的脚本，编辑文件为/etc/init.d/networking。
2. 该例子中使用一些函数，例如log_warning_msg。定义在/lib/lsb/init-functions文件中。在第19行使用“. /lib/lsb/init-functions”（点号加文件名）表示调用另一个脚本。
3. 该例子中使用&&和||逻辑运算符，利用其短路性质。当&&连接两个表达式时，只有左边表达式为真时计算右边表达式。当||连接两个表达式时，只有左边表达式为假时计算右边表达式。
4. 关于Linux启动脚本和如何编写启动脚本另做研究总结。

*参考文档：*
*1. [Linux Standard Base][6]*
*2. [分析 shell 中 的 复杂的 && 和 || 表达式][7]*
*3. [理解Linux系统/etc/init.d目录和/etc/rc.local脚本][8]*
*4. [Linux exec与重定向][12]*

# 个人观点
- shell脚本的掌握程度是：能够编写基本的脚本，同时能够理解他人的脚本。
- shell脚本编程时出现错误的原因多数是因为未理解shell脚本的实质，与C语言混淆。shell脚本的实质是为了执行一系列命令。
- C语言中提供了调用shell脚本的方法，具体内容另起研究总结。

[1]: http://www.cnblogs.com/hu983/p/5450693.html
[2]: http://blog.csdn.net/taiyang1987912/article/details/39551385
[3]: https://gist.github.com/youxiaobo/0413bbaeb9100733aa1a6c08309d844b
[4]: http://www.cnblogs.com/sammei/p/4119659.html
[5]: http://blog.csdn.net/flexman09/article/details/52117279
[6]: https://en.wikipedia.org/wiki/Linux_Standard_Base
[7]: http://blog.csdn.net/sinat_30196907/article/details/48436979
[8]: http://blog.csdn.net/acs713/article/details/7322082
[9]: http://blog.csdn.net/zsy2020314/article/details/9312147
[10]: http://www.cnblogs.com/ggjucheng/archive/2013/01/13/2858470.html
[11]: http://blog.csdn.net/engledb/article/details/19623087
[12]: http://blog.csdn.net/21aspnet/article/details/7487770
[13]: http://www.youbo.website/2017/10/18/Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8--4%E5%B8%B8%E7%94%A8shell%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB/
